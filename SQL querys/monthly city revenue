-- Monthly Revenue Analysis
WITH monthly_revenue_analysis AS (
    **SELECT **
        dc.city_name,
        dd.month_name,
        SUM(ft.fare_amount) AS monthly_revenue
    FROM fact_trips ft
    JOIN dim_city dc USING (city_id)
    JOIN dim_date dd USING (date)
    GROUP BY city_name, month_name
),

-- Total Revenue by City
city_total_revenue AS (
    SELECT 
        city_name,
        SUM(monthly_revenue) AS total_city_revenue
    FROM monthly_revenue_analysis
    GROUP BY city_name
),

-- Highest Revenue Month for Each City
highest_revenue_month AS (
    SELECT 
        mcr.city_name,
        mcr.month_name AS highest_revenue_month,
        mcr.monthly_revenue,
        CONCAT(ROUND((mcr.monthly_revenue * 100 / ctr.total_city_revenue), 2), "%") AS percentage_contribution
    FROM monthly_revenue_analysis mcr
    JOIN city_total_revenue ctr ON mcr.city_name = ctr.city_name
    WHERE mcr.monthly_revenue = (
        SELECT MAX(monthly_revenue)
        FROM monthly_revenue_analysis sub_mcr
        WHERE sub_mcr.city_name = mcr.city_name
    )
)

-- Final Output
SELECT 
    city_name,
    highest_revenue_month,
    monthly_revenue,
    percentage_contribution
FROM highest_revenue_month;
